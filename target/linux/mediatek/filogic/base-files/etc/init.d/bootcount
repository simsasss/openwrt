#!/bin/sh /etc/rc.common
# SPDX-License-Identifier: GPL-2.0-only

START=99

boot() {
	case $(board_name) in
	xiaomi,mi-router-ax3000t)
		. /lib/upgrade/common.sh
		[ "$(rootfs_type)" = "tmpfs" ] && \
			logger "bootcount: initramfs mode detected, exit" && \
			return 0
		[ "$(fw_printenv -n flag_try_sys2_failed 2>&1)" = "8" ] && \
			logger "bootcount: rd03 model detected, exit" && \
			return 0
		fw_setenv -s - <<-EOF
			flag_boot_rootfs 0
			flag_boot_success 1
			flag_last_success 0
			flag_ota_reboot 0
			flag_try_sys1_failed 0
			flag_try_sys2_failed 0
		EOF
		logger "bootcount: rd23 model detected, nvram was updated"
		;;
	teltonika,rutcxx-emmc|\
	teltonika,rutc50)
		#Bootloader expect successfull startup value after update, we need to write success value to bootconfig partition
		#otherwise bootloader will fallback to previous root partition

		#while true; do value=$(hexdump -e '8/1 "%02x"' -n 16 -s "$offset" /dev/mtd5); echo "value: $value"; offset=$(( offset + 16 )); [ "$offset" -ge 1024 ] && break; done

		. /lib/functions.sh
		local PART="$(cmdline_get_var ubi.mtd)"
		local MTD_INDEX=$(find_mtd_index bootconfig-a)

		[ -z "$PART" ] && {
			if [ "$(hexdump -e '"%02x"' /proc/device-tree/chosen/rootdisk)" = "$(hexdump -e '"%02x"' /proc/device-tree/chosen/rootdisk-rutos-a)" ];
			then
				PART=rutos-a
			else
				PART=rutos-b
			fi
		}

		case "$PART" in
		rutos-a)
			[ "$(md5sum /dev/mtd$MTD_INDEX | awk '{print $1}')" = "adc4a78e76efc6b4afdc41925e4017c6" ] || {
				logger -t "bootcount" "saving new failsafe boot config in /dev/mtd$MTD_INDEX bootconfig-a partition rutos-a"
				echo -ne "\xe1\xb0\xba\xba\x01\x00\xf9\x01\xf8\x01\xf0\x00\x3d\xd4\xfb\x95" | mtd -e bootconfig-a write - bootconfig-a
			}
			;;
		rutos-b)
			[ "$(md5sum /dev/mtd$MTD_INDEX | awk '{print $1}')" = "2904b3476604ef153d1925acdde062e8" ] || {
				logger -t "bootcount" "saving new failsafe boot config in /dev/mtd$MTD_INDEX bootconfig-a partition rutos-b"
				echo -ne "\xe1\xb0\xba\xba\x01\x01\xf7\x01\xf8\x00\xf0\x00\xce\xd4\x44\x08" | mtd -e bootconfig-a write - bootconfig-a
				}
			;;
		esac
		;;
	zyxel,ex5700-telenor)
		fw_setenv uboot_bootcount 0
		;;
	esac
}
